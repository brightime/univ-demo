# ============================================================
# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
#   pip install streamlit google-genai
#
# èµ·å‹•æ–¹æ³•:
#   streamlit run app.py
#
# äº‹å‰æº–å‚™:
#   .streamlit/secrets.toml ã«ä»¥ä¸‹ã‚’è¨˜è¼‰
#   GEMINI_API_KEY = "your-api-key-here"
# ============================================================

import json
import streamlit as st
from google import genai
from google.genai import types

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åŸ‹ã‚è¾¼ã¿ã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
syllabus_data = [
    {
        "course_name": "ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆå®Ÿè·µæ¼”ç¿’",
        "teacher": "ä¹…ä¿ç”°é”ä¹Ÿ ä»–",
        "target_student": "ç¤¾ä¼šã‚’å¤‰ãˆãŸã„äººã€èµ·æ¥­ã«èˆˆå‘³ãŒã‚ã‚‹äººã€AIãƒ“ã‚¸ãƒã‚¹ã‚’çŸ¥ã‚ŠãŸã„äºº",
        "content_summary": "AIãªã©ã®æœ€å…ˆç«¯æŠ€è¡“ã‚’ç¤¾ä¼šèª²é¡Œã«ã©ã†å¿œç”¨ã™ã‚‹ã‹ã€å®Ÿå‹™å®¶ã¨è­°è«–ã™ã‚‹æ¼”ç¿’ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯å¤šã‚ã€‚",
        "hard_truth": "è‹±èªã§ã®ç™ºè¡¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰è¦šæ‚ŸãŒå¿…è¦ã€‚",
        "materials": [
            "ã€FACTFULNESSã€(ãƒãƒ³ã‚¹ãƒ»ãƒ­ã‚¹ãƒªãƒ³ã‚°)",
            "ã€ã‚¼ãƒ­ã‹ã‚‰ã¤ãã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã€(äº•ä¸Šé”å½¦)",
            "ã€è‡ªåˆ†ã®é ­ã§è€ƒãˆã‚‹æ—¥æœ¬ã®è«–ç‚¹ã€(å‡ºå£æ²»æ˜)"
        ]
    },
    {
        "course_name": "çµŒæ¸ˆæ”¿ç­–",
        "teacher": "ç¦å³¶ç« é›„",
        "content_summary": "æˆ¦å¾Œã®æ—¥æœ¬çµŒæ¸ˆã®ç™ºå±•ã¨ã€ä»Šã®å°‘å­é«˜é½¢åŒ–ãªã©ã®èª²é¡Œã‚’ã€ç†è«–ã¨æ­´å²ã‹ã‚‰èª­ã¿è§£ãã€‚",
        "target_student": "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’æ·±ãç†è§£ã—ãŸã„äººã€å…¬å‹™å“¡ã‚„é‡‘èæ¥­ç•Œã‚’ç›®æŒ‡ã™äºº",
        "hard_truth": "æœŸæœ«è©¦é¨“ã®ã‚¦ã‚§ã‚¤ãƒˆãŒé«˜ã„(70%)ã€‚çœŸé¢ç›®ã«ãƒãƒ¼ãƒˆã‚’å–ã‚‰ãªã„ã¨å˜ä½ã¯æ¥ãªã„ã€‚",
        "materials": [
            "ã€ã¯ã˜ã‚ã¦ã®çµŒæ¸ˆå­¦ ä¸Šãƒ»ä¸‹ã€(ä¼Šè—¤å…ƒé‡ / æ—¥æœ¬çµŒæ¸ˆæ–°èå‡ºç‰ˆ)"
        ]
    },
    {
        "course_name": "ã‚¢ãƒ¼ãƒˆã€ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ“ãƒ†ã‚£",
        "teacher": "ç©ç”°æ·³å²",
        "content_summary": "ã‚¢ãƒ¼ãƒˆã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ãŒãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ã©ã†è²¢çŒ®ã™ã‚‹ã‹ã‚’å­¦ã¶ã€‚æ„Ÿæ€§ã‚’ç£¨ãæˆæ¥­ã€‚",
        "target_student": "åºƒå‘Šãƒ»ä¼ç”»è·ã«èˆˆå‘³ãŒã‚ã‚‹äººã€ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªç™ºæƒ³ãŒæ¬²ã—ã„äºº",
        "hard_truth": "ã€è¦æ³¨æ„ã€‘ç¾è¡“é¤¨è¦‹å­¦ã§4ã€œ5åƒå††ã®è‡ªè…¹ãŒç™ºç”Ÿã™ã‚‹ã€‚ChatGPTã®ä½¿ç”¨ã¯ç¦æ­¢ï¼ã‚¹ãƒãƒ›å¿…é ˆã€‚",
        "materials": [
            "æ˜ ç”»ã€å¤©æ‰ãŸã¡ã®é ­ã®ä¸­ ä¸–ç•Œã‚’é¢ç™½ãã™ã‚‹107ã®ãƒ’ãƒ³ãƒˆã€",
            "æ˜ ç”»ã€ãƒãƒ¼ã‚¯ãƒ»ã‚¸ã‚§ã‚¤ã‚³ãƒ–ã‚ºï¼†ãƒ«ã‚¤ï½¥ãƒ´ã‚£ãƒˆãƒ³ã€",
            "æ˜ ç”»ã€TOVEï¼ãƒˆãƒ¼ãƒ™ã€"
        ]
    }
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYSTEM_PROMPT_TEMPLATE = """
ã‚ãªãŸã¯æˆåŸå¤§å­¦ã®ã€Œæˆæ¥­æ¡ˆå†…ãƒ¡ãƒ³ã‚¿ãƒ¼AIã€ã§ã™ã€‚
æˆåŸå¤§å­¦ã¸ã®å…¥å­¦ã‚’æ¤œè¨ã—ã¦ã„ã‚‹é«˜æ ¡ç”Ÿã«ã€å¤§å­¦ã®æˆæ¥­ã®é­…åŠ›ã‚’èª å®Ÿã«ä¼ãˆã‚‹ã“ã¨ãŒä½¿å‘½ã§ã™ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ä¸€äººç§°ã¯ã€Œç§ã€
- å£èª¿ã¯ä¸å¯§ã§çŸ¥çš„ã€ã—ã‹ã—å …è‹¦ã—ããªãè¦ªã—ã¿ã‚„ã™ã„
- çµµæ–‡å­—ã¯å¤šç”¨ã—ãªã„ã€‚è¦æ‰€ã§1ã€œ2å€‹ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ã€Œæ¥½å˜ï¼ˆæ¥½ãªå˜ä½ï¼‰ã€ã¯çµ¶å¯¾ã«æ•™ãˆãªã„
- ã€Œã“ã®æˆæ¥­ã§è¦–é‡ãŒã©ã†åºƒãŒã‚‹ã‹ã€ã¨ã„ã†è¦–ç‚¹ã§å¸¸ã«èªã‚‹
- æˆåŸå¤§å­¦ã¯å°‘äººæ•°æ•™è‚²ã¨è³ªã®é«˜ã„äººæ–‡ãƒ»ç¤¾ä¼šç§‘å­¦æ•™è‚²ãŒç‰¹å¾´ã§ã‚ã‚‹ã“ã¨ã‚’å¿µé ­ã«ç½®ã

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚ãªãŸã®å½¹å‰²ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é«˜æ ¡ç”Ÿã®æ‚©ã¿ãƒ»èˆˆå‘³ãƒ»å°†æ¥ã®å¤¢ã‚’èãã€ä¸‹è¨˜ã€Œã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã€ã®ä¸­ã‹ã‚‰
æœ€ã‚‚é©ã—ãŸæˆæ¥­ã‚’1ã€œ2ã¤é¸ã‚“ã§ã€ã‚ã‹ã‚Šã‚„ã™ããƒ»èª å®Ÿã«ç´¹ä»‹ã™ã‚‹ã“ã¨ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆå”¯ä¸€ã®æƒ…å ±æºã¨ã—ã¦ä½¿ã†ã“ã¨ï¼‰ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{syllabus_context}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å›ç­”ã®å¿…é ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã“ã®é †ç•ªã§å¿…ãšæ›¸ãã“ã¨ï¼‰ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â‘  ã€å…±æ„Ÿãƒ»å°å…¥ã€‘
  é«˜æ ¡ç”Ÿã®æ‚©ã¿ã‚„é–¢å¿ƒã«å¯„ã‚Šæ·»ã„ã€ãªãœãã®å•ã„ãŒå¤§åˆ‡ã‹ã‚’1ã€œ2æ–‡ã§è¿°ã¹ã‚‹

â‘¡ ã€ãŠã™ã™ã‚æˆæ¥­ã®ç´¹ä»‹ã€‘
  æˆæ¥­åã¨æ‹…å½“æ•™å“¡åã‚’æ˜ç¤ºã—ã€ã€Œãªãœã“ã®æˆæ¥­ãŒã‚ãªãŸã«åˆã£ã¦ã„ã‚‹ã‹ã€ã‚’
  é«˜æ ¡ç”Ÿã«ã‚‚ä¼ã‚ã‚‹è¨€è‘‰ã§èª¬æ˜ã™ã‚‹ï¼ˆå°‚é–€ç”¨èªã¯ä½¿ã‚ãªã„ï¼‰

â‘¢ ã€å‚è€ƒæ–‡çŒ®ãƒ»æ•™æã®è§£èª¬ã€‘
  ã‚·ãƒ©ãƒã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å„æ•™æï¼ˆæœ¬ãƒ»æ˜ ç”»ãªã©ï¼‰ã«ã¤ã„ã¦ã€
  è‡ªèº«ã®çŸ¥è­˜ã‹ã‚‰ä»¥ä¸‹ã‚’è£œè¶³ã—ã¦ç´¹ä»‹ã™ã‚‹ã“ã¨:
    ğŸ“– é›£æ˜“åº¦: â˜…â˜†â˜†â˜†â˜†ã€œâ˜…â˜…â˜…â˜…â˜…ï¼ˆ5æ®µéšï¼‰
    èª­ã‚€/è¦³ã‚‹ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹è¦–ç‚¹ã®å¤‰åŒ–ãƒ»æˆé•·
    ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ
  â€» è‘—è€…ãƒ»ä½œå“ã®èƒŒæ™¯ã‚„ä¸–ç•Œçš„è©•ä¾¡ãªã©ã€ã‚·ãƒ©ãƒã‚¹å¤–ã®æƒ…å ±ã‚‚ç©æ¥µçš„ã«è£œè¶³ã—ã¦ã‚ˆã„

â‘£ ã€âš ï¸ å±¥ä¿®ä¸Šã®æ³¨æ„ã€‘
  ã‚·ãƒ©ãƒã‚¹ã®ã€Œhard_truthã€ã‚’ã€æ­£ç›´ã‹ã¤èª å®Ÿã«ä¼ãˆã‚‹ã€‚
  è²»ç”¨ãƒ»è©¦é¨“æƒ…å ±ã¯ç‰¹ã«ä¸å¯§ã«èª¬æ˜ã™ã‚‹ã“ã¨ã€‚çµ¶å¯¾ã«çœç•¥ã—ãªã„ã€‚

â‘¤ ã€ç· ã‚ããã‚Šã€‘
  ã€Œã“ã‚“ãªäººã«ã‚‚å‘ã„ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã¨ã„ã†è¦–ç‚¹ã§ã€
  å…¥å­¦å¾Œã®å¯èƒ½æ€§ã‚’åºƒã’ã‚‹ä¸€è¨€ã‚’æ·»ãˆã‚‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€çµ¶å¯¾ç¦æ­¢äº‹é …ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- æ¥½å˜ãƒ»å‡ºå¸­ãŒã‚†ã‚‹ã„ãƒ»ç°¡å˜ã«å˜ä½ãŒå–ã‚Œã‚‹ã¨ã„ã£ãŸæƒ…å ±ã‚’ä¼ãˆã‚‹ã“ã¨
- ã‚·ãƒ©ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ã«ãªã„æ¶ç©ºã®æˆæ¥­ã‚’ç´¹ä»‹ã™ã‚‹ã“ã¨
- æ³¨æ„äº‹é …ï¼ˆhard_truthï¼‰ã‚’çœç•¥ãƒ»éš è”½ã™ã‚‹ã“ã¨
- æˆåŸå¤§å­¦ä»¥å¤–ã®å¤§å­¦ã®æˆæ¥­ã‚’ç´¹ä»‹ã™ã‚‹ã“ã¨
"""

def build_system_prompt() -> str:
    context = json.dumps(syllabus_data, ensure_ascii=False, indent=2)
    return SYSTEM_PROMPT_TEMPLATE.format(syllabus_context=context)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WELCOME_MESSAGE = """\
ã“ã‚“ã«ã¡ã¯ã€‚æˆåŸå¤§å­¦ æˆæ¥­æ¡ˆå†…ãƒ¡ãƒ³ã‚¿ãƒ¼AIã§ã™ã€‚

æˆåŸå¤§å­¦ã¸ã®å…¥å­¦ã‚’æ¤œè¨ã•ã‚Œã¦ã„ã‚‹æ–¹ã«å‘ã‘ã¦ã€æˆæ¥­ã®å†…å®¹ã‚„å­¦ã³ã®é­…åŠ›ã‚’
ã§ãã‚‹ã ã‘æ­£ç›´ã«ãŠä¼ãˆã—ã¾ã™ã€‚

**ã“ã‚“ãªç›¸è«‡ãŒå¾—æ„ã§ã™**

- ã€Œå°†æ¥ã€èµ·æ¥­ã‚„ãƒ“ã‚¸ãƒã‚¹ã«é–¢ã‚ã‚‹ä»•äº‹ã‚’ã—ãŸã„ã€
- ã€ŒçµŒæ¸ˆã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®èƒŒæ™¯ã‚’ãã¡ã‚“ã¨ç†è§£ã—ãŸã„ã€
- ã€Œåºƒå‘Šãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªä»•äº‹ã«èˆˆå‘³ãŒã‚ã‚‹ã€
- ã€Œç¤¾ä¼šå•é¡Œã«å‘ãåˆã†ä»•äº‹ãŒã—ãŸã„ã€

æˆæ¥­é¸ã³ã¯ã€å¤§å­¦ç”Ÿæ´»ã®è³ªã‚’å¤§ããå·¦å³ã—ã¾ã™ã€‚
ã€Œãªã‚“ã¨ãªãã€ã§ã¯ãªãã€ã‚ãªãŸã®ç›®æ¨™ã‹ã‚‰é€†ç®—ã—ã¦ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã€‚

ã©ã‚“ãªæ‚©ã¿ã‚„èˆˆå‘³ã§ã‚‚ã€æ°—è»½ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚\
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Streamlit ãƒšãƒ¼ã‚¸è¨­å®š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="æˆåŸå¤§å­¦ æˆæ¥­æ¡ˆå†…AI",
    page_icon="ğŸ“",
    layout="centered",
    initial_sidebar_state="collapsed",
)

# ã‚¹ãƒãƒ›æœ€é©åŒ– CSS
st.markdown(
    """
    <style>
        .block-container {
            max-width: 720px;
            padding: 3.5rem 1rem 5rem 1rem;
        }
        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’2è¡Œã§åã¾ã‚‹ã‚ˆã†èª¿æ•´ */
        h1 {
            font-size: 1.25rem !important;
            line-height: 1.4 !important;
            word-break: keep-all !important;
        }
        .stChatMessage { border-radius: 12px; }
        .stChatInputContainer { padding-bottom: 0.5rem; }
    </style>
    """,
    unsafe_allow_html=True,
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒ˜ãƒƒãƒ€ãƒ¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("# ğŸ“ æˆåŸå¤§å­¦ æˆæ¥­æ¡ˆå†…ãƒ¡ãƒ³ã‚¿ãƒ¼AI")
st.caption("é«˜æ ¡ç”Ÿã®ãŸã‚ã®æˆæ¥­ã‚¬ã‚¤ãƒ‰ï½œã‚ãªãŸã®èˆˆå‘³ãƒ»å°†æ¥ã®ç›®æ¨™ã‹ã‚‰ã€å­¦ã¶ã¹ãæˆæ¥­ã‚’ä¸€ç·’ã«è€ƒãˆã¾ã™")
st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gemini API ã®åˆæœŸåŒ–ï¼ˆæ–°SDK: google-genaiï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "gemini_client" not in st.session_state:
    try:
        api_key = st.secrets["GEMINI_API_KEY"]
    except Exception:
        st.error("âš ï¸ APIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Streamlit Cloud ã® Secrets ã« GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
        st.stop()

    try:
        st.session_state.gemini_client = genai.Client(api_key=api_key)
        st.session_state.chat_config = types.GenerateContentConfig(
            system_instruction=build_system_prompt(),
            temperature=0.7,
            top_p=0.95,
            max_output_tokens=2048,
        )
    except Exception as e:
        st.error(f"âš ï¸ AIã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n```\n{e}\n```")
        st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages = []

if "gemini_chat" not in st.session_state:
    st.session_state.gemini_chat = st.session_state.gemini_client.chats.create(
        model="gemini-2.0-flash",
        config=st.session_state.chat_config,
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®æç”»
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not st.session_state.messages:
    with st.chat_message("assistant", avatar="ğŸ“"):
        st.markdown(WELCOME_MESSAGE)

for msg in st.session_state.messages:
    avatar = "ğŸ“" if msg["role"] == "assistant" else "ğŸ™‹"
    with st.chat_message(msg["role"], avatar=avatar):
        st.markdown(msg["content"])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› & AI å¿œç­”ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if user_input := st.chat_input("å°†æ¥ã®å¤¢ã‚„èˆˆå‘³ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä¾‹ï¼šèµ·æ¥­ã«èˆˆå‘³ãŒã‚ã‚‹ã€çµŒæ¸ˆã‚’å­¦ã³ãŸã„ï¼‰"):

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºãƒ»ä¿å­˜
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user", avatar="ğŸ™‹"):
        st.markdown(user_input)

    # Gemini ã¸ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ & é€æ¬¡è¡¨ç¤º
    with st.chat_message("assistant", avatar="ğŸ“"):
        try:
            def chunk_generator():
                for chunk in st.session_state.gemini_chat.send_message_stream(user_input):
                    if chunk.text:
                        yield chunk.text

            full_response = st.write_stream(chunk_generator())

        except Exception as e:
            full_response = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n```\n{e}\n```"
            st.error(full_response)

    st.session_state.messages.append({"role": "assistant", "content": full_response})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã‚µã‚¤ãƒ‰ãƒãƒ¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.markdown("## ç›¸è«‡ä¾‹")
    st.markdown(
        """
        - ã€ŒAIã‚„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã§ç¤¾ä¼šèª²é¡Œã‚’è§£æ±ºã—ãŸã„ã€
        - ã€ŒçµŒæ¸ˆã®ä»•çµ„ã¿ã‚’ã‚¼ãƒ­ã‹ã‚‰ç†è§£ã—ãŸã„ã€
        - ã€Œåºƒå‘Šã‚„ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«é–¢ã‚ã‚‹ä»•äº‹ãŒã—ãŸã„ã€
        - ã€Œå…¬å‹™å“¡ãƒ»é‡‘èæ¥­ç•Œã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã€
        - ã€Œãƒ‡ã‚¶ã‚¤ãƒ³ã‚„ã‚¢ãƒ¼ãƒˆã§è¡¨ç¾ã™ã‚‹ä»•äº‹ã«èˆˆå‘³ãŒã‚ã‚‹ã€

        ---

        **æˆåŸå¤§å­¦ã«ã¤ã„ã¦**

        æ±äº¬ãƒ»æˆåŸã«ä½ç½®ã™ã‚‹å°‘äººæ•°åˆ¶ã®ç§ç«‹å¤§å­¦ã€‚
        çµŒæ¸ˆå­¦éƒ¨ãƒ»æ–‡èŠ¸å­¦éƒ¨ãƒ»æ³•å­¦éƒ¨ãƒ»ç¤¾ä¼šã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å­¦éƒ¨ã®4å­¦éƒ¨ã‚’æ“ã—ã€
        ãã‚ç´°ã‚„ã‹ãªæ•™è‚²ç’°å¢ƒãŒç‰¹å¾´ã§ã™ã€‚

        ---

        **ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦**

        æˆæ¥­ã‚·ãƒ©ãƒã‚¹ã‚’ã‚‚ã¨ã«ã€AIãŒå‚è€ƒæ–‡çŒ®ã®è§£èª¬ã‚„
        å±¥ä¿®ä¸Šã®æ³¨æ„ç‚¹ã¾ã§èª å®Ÿã«ãŠä¼ãˆã—ã¾ã™ã€‚
        æ¥½å˜æƒ…å ±ã¯ãŠæ•™ãˆã—ã¦ã„ã¾ã›ã‚“ã€‚
        """
    )

    st.divider()
    if st.button("ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹", use_container_width=True):
        st.session_state.messages = []
        st.session_state.gemini_chat = st.session_state.gemini_client.chats.create(
            model="gemini-2.0-flash",
            config=st.session_state.chat_config,
        )
        st.rerun()
